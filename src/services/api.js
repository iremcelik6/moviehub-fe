import axios from 'axios';

const API_BASE_URL = 'https://moviehub-9b64.onrender.com/api';

// API instance olu≈ütur
const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  timeout: 10000, // 10 saniye timeout
});

// Request interceptor - her istekte token ekle ve log
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    
    console.log(`üöÄ API Request: ${config.method?.toUpperCase()} ${config.url}`);
    return config;
  },
  (error) => {
    console.error('‚ùå Request Error:', error);
    return Promise.reject(error);
  }
);

// Response interceptor - yanƒ±tlarƒ± logla ve hatalarƒ± yakala
api.interceptors.response.use(
  (response) => {
    console.log(`‚úÖ API Response: ${response.status} ${response.config.url} - ${response.data?.length || 'N/A'} items`);
    return response;
  },
  async (error) => {
    const status = error.response?.status;
    const url = error.config?.url;
    const errorData = error.response?.data;
    
    console.error(`‚ùå API Error: ${status} ${url}`, errorData || error.message);
    
    // Sadece ger√ßek auth hatalarƒ±nda session'ƒ± temizle
    if ((status === 401 || status === 403) && 
        errorData?.message?.toLowerCase().includes('expired') || 
        errorData?.message?.toLowerCase().includes('invalid token')) {
      console.warn('üîê Token expired or invalid, clearing session...');
      
      // Token'ƒ± temizle
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      
      // Login sayfasƒ±na y√∂nlendir (sadece auth gerekli sayfalarda)
      if (window.location.pathname !== '/login' && window.location.pathname !== '/register') {
        //alert('Your session has expired. Please login again.');
        window.location.href = '/login';
      }
    } else if (status === 403) {
      // Yetki hatasƒ± - session'ƒ± temizleme, sadece uyarƒ± g√∂ster
      console.warn('‚ö†Ô∏è Permission denied for this operation');
      //alert('You do not have permission to perform this action.');
    }
    
    return Promise.reject(error);
  }
);

// Movies API
export const moviesAPI = {
  // T√ºm filmleri getir
  getAll: () => {
    console.log('üì• T√ºm filmler getiriliyor...');
    return api.get('/movies');
  },
  
  // ID ile film getir
  getById: (id) => {
    console.log(`üì• Film getiriliyor: ID ${id}`);
    return api.get(`/movies/${id}`);
  },
  
  // Ba≈ülƒ±k ile film ara
  search: (title) => {
    console.log(`üîç Film aramasƒ±: "${title}"`);
    return api.get(`/movies/search?title=${encodeURIComponent(title)}`);
  },
  
  // T√ºre g√∂re film getir
  getByGenre: (genre) => {
    console.log(`üì• T√ºre g√∂re filmler: "${genre}"`);
    return api.get(`/movies/genre/${encodeURIComponent(genre)}`);
  },
  
  // Yeni film olu≈ütur (Admin)
  create: (movie) => {
    console.log('‚ûï Yeni film olu≈üturuluyor:', movie.title);
    return api.post('/movies', movie);
  },
  
  // Film g√ºncelle (Admin)
  update: (id, movie) => {
    console.log(`‚úèÔ∏è Film g√ºncelleniyor: ID ${id}`);
    return api.put(`/movies/${id}`, movie);
  },
  
  // Film sil (Admin)
  delete: (id) => {
    console.log(`üóëÔ∏è Film siliniyor: ID ${id}`);
    return api.delete(`/movies/${id}`);
  }
};

// Series API
export const seriesAPI = {
  // T√ºm dizileri getir
  getAll: () => {
    console.log('üì• T√ºm diziler getiriliyor...');
    return api.get('/series');
  },
  
  // ID ile dizi getir
  getById: (id) => {
    console.log(`üì• Dizi getiriliyor: ID ${id}`);
    return api.get(`/series/${id}`);
  },
  
  // Ba≈ülƒ±k ile dizi ara
  search: (title) => {
    console.log(`üîç Dizi aramasƒ±: "${title}"`);
    return api.get(`/series/search?title=${encodeURIComponent(title)}`);
  },
  
  // T√ºre g√∂re dizi getir
  getByGenre: (genre) => {
    console.log(`üì• T√ºre g√∂re diziler: "${genre}"`);
    return api.get(`/series/genre/${encodeURIComponent(genre)}`);
  },
  
  // Yeni dizi olu≈ütur (Admin)
  create: (series) => {
    console.log('‚ûï Yeni dizi olu≈üturuluyor:', series.title);
    return api.post('/series', series);
  },
  
  // Dizi g√ºncelle (Admin)
  update: (id, series) => {
    console.log(`‚úèÔ∏è Dizi g√ºncelleniyor: ID ${id}`);
    return api.put(`/series/${id}`, series);
  },
  
  // Dizi sil (Admin)
  delete: (id) => {
    console.log(`üóëÔ∏è Dizi siliniyor: ID ${id}`);
    return api.delete(`/series/${id}`);
  }
};

// Auth API
export const authAPI = {
  // Kullanƒ±cƒ± giri≈üi
  login: (credentials) => {
    console.log('üîê Kullanƒ±cƒ± giri≈üi:', credentials.username);
    return api.post('/auth/login', credentials);
  },
  
  // Kullanƒ±cƒ± kaydƒ±
  register: (userData) => {
    console.log('üìù Yeni kullanƒ±cƒ± kaydƒ±:', userData.username);
    return api.post('/auth/register', userData);
  }
};

// Reviews API
export const reviewsAPI = {
  // ƒ∞√ßerik yorumlarƒ±nƒ± getir
  getByContent: (contentId, contentType) => {
    console.log(`üì• Getting reviews for: ${contentType} ID ${contentId}`);
    return api.get(`/reviews/content/${contentId}/${contentType}`);
  },
  
  // Kullanƒ±cƒ± yorumlarƒ±nƒ± getir
  getByUser: (userId) => {
    console.log(`üì• Getting user reviews: ID ${userId}`);
    return api.get(`/reviews/user/${userId}`);
  },
  
  // Yeni yorum ekle
  create: (review) => {
    console.log('‚ûï Adding new review:', review.contentType, review.contentId);
    return api.post('/reviews', review);
  },
  
  // Yorum sil
  delete: async (reviewId) => {
    console.log(`üóëÔ∏è Deleting review: ID ${reviewId}`);
    try {
      const response = await api.delete(`/reviews/${reviewId}`);
      console.log('‚úÖ Review deleted successfully');
      return response;
    } catch (error) {
      console.error('‚ùå Failed to delete review:', error.response?.data || error.message);
      throw error;
    }
  },
  
  // Kullanƒ±cƒ± yorumlarƒ±nƒ± getir
  getReviewUser: (reviewId) => {
    console.log(`üì• Getting review user: ID ${reviewId}`);
    return api.get(`/reviews/${reviewId}/user`)
      .then(response => {
        console.log(`‚úÖ User info received for review ${reviewId}:`, response.data);
        return response;
      })
      .catch(error => {
        console.error(`‚ùå Error getting user info for review ${reviewId}:`, error.response?.data || error.message);
        throw error;
      });
  }
};

// Ratings API
export const ratingsAPI = {
  // ƒ∞√ßerik puanlarƒ±nƒ± getir
  getContentRating: (contentId, contentType) => {
    console.log(`üìä Puanlar getiriliyor: ${contentType} ID ${contentId}`);
    return api.get(`/ratings/content/${contentId}/${contentType}`);
  },
  
  // Kullanƒ±cƒ±nƒ±n puanƒ±nƒ± getir
  getUserRating: (contentId, contentType) => {
    console.log(`üë§ Kullanƒ±cƒ± puanƒ±: ${contentType} ID ${contentId}`);
    return api.get(`/ratings/user/${contentId}/${contentType}`);
  },
  
  // Puan ver veya g√ºncelle
  createOrUpdate: (rating) => {
    console.log(`‚≠ê Puan veriliyor: ${rating.contentType} ID ${rating.contentId} - ${rating.score}/10`);
    return api.post('/ratings', rating);
  }
};

// Favorites API
export const favoritesAPI = {
  // Kullanƒ±cƒ± favorilerini getir
  getUserFavorites: async () => {
    console.log('üì• Getting user favorites...');
    try {
      const response = await api.get('/favorites');
      console.log('‚úÖ Favorites loaded successfully:', response.data);
      return response;
    } catch (error) {
      console.error('‚ùå Failed to load favorites:', error.response?.data || error.message);
      throw error;
    }
  },
  
  // Favorilere ekle
  add: async (contentId, contentType) => {
    console.log(`‚ù§Ô∏è Adding to favorites: ${contentType} ID ${contentId}`);
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        throw new Error('No authentication token found');
      }
      
      const response = await api.post('/favorites', { contentId, contentType });
      console.log('‚úÖ Added to favorites successfully');
      return response;
    } catch (error) {
      // Yetki hatasƒ± durumunda √∂zel mesaj
      if (error.response?.status === 403) {
        //throw new Error('You do not have permission to add favorites');
      }
      console.error('‚ùå Failed to add to favorites:', error.response?.data || error.message);
      throw error;
    }
  },
  
  // Favorilerden √ßƒ±kar
  remove: async (contentId, contentType) => {
    console.log(`üíî Removing from favorites: ${contentType} ID ${contentId}`);
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        throw new Error('No authentication token found');
      }
      
      const response = await api.delete(`/favorites/${contentId}/${contentType}`);
      console.log('‚úÖ Removed from favorites successfully');
      return response;
    } catch (error) {
      // Yetki hatasƒ± durumunda √∂zel mesaj
      if (error.response?.status === 403) {
        throw new Error('You do not have permission to remove favorites');
      }
      console.error('‚ùå Failed to remove from favorites:', error.response?.data || error.message);
      throw error;
    }
  },
  
  // Favori kontrol√º
  check: async (contentId, contentType) => {
    console.log(`‚ùì Checking favorite status: ${contentType} ID ${contentId}`);
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        return { data: { isFavorite: false } };
      }
      
      const response = await api.get(`/favorites/check/${contentId}/${contentType}`);
      console.log('‚úÖ Favorite status checked:', response.data);
      return response;
    } catch (error) {
      console.error('‚ùå Failed to check favorite status:', error.response?.data || error.message);
      return { data: { isFavorite: false } };
    }
  }
};

// Utility functions
export const apiUtils = {
  // Backend saƒülƒ±k kontrol√º
  healthCheck: async () => {
    try {
      console.log('üè• Backend saƒülƒ±k kontrol√º...');
      const response = await fetch(`${API_BASE_URL}/actuator/health`, {
        method: 'GET',
        timeout: 5000
      });
      return response.ok;
    } catch (error) {
      console.error('‚ùå Backend saƒülƒ±k kontrol√º ba≈üarƒ±sƒ±z:', error);
      return false;
    }
  },
  
  // Basit baƒülantƒ± testi
  testConnection: async () => {
    try {
      console.log('üîó Backend baƒülantƒ± testi...');
      const response = await api.get('/movies', { timeout: 3000 });
      return { success: true, data: response.data };
    } catch (error) {
      console.error('‚ùå Baƒülantƒ± testi ba≈üarƒ±sƒ±z:', error.message);
      return { success: false, error: error.message };
    }
  }
};

// DEBUG fonksiyonlarƒ±
export const debugAPI = {
  // Manuel movies test
  testMoviesDirectly: async () => {
    try {
      console.log('üß™ Direct Movies API Test ba≈ülƒ±yor...');
      
      // Direkt fetch ile test
      const response = await fetch('https://moviehub-9b64.onrender.com/api/movies', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      console.log('=== DIRECT API TEST RESULTS ===');
      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);
      console.log('Response headers:', [...response.headers.entries()]);
      
      const text = await response.text();
      console.log('Response text length:', text.length);
      console.log('Response text preview:', text.substring(0, 200));
      
      // JSON parse dene
      try {
        const json = JSON.parse(text);
        console.log('‚úÖ JSON parsed successfully');
        console.log('Parsed data type:', typeof json);
        console.log('Is array:', Array.isArray(json));
        console.log('Array length:', json.length);
        console.log('First item:', json[0]);
        return { success: true, data: json };
      } catch (parseError) {
        console.error('‚ùå JSON parse hatasƒ±:', parseError);
        return { success: false, error: 'JSON parse failed', raw: text };
      }
      
    } catch (error) {
      console.error('‚ùå Direct API test hatasƒ±:', error);
      return { success: false, error: error.message };
    }
  },

  // Backend endpoint'lerini test et
  testAllEndpoints: async () => {
    const endpoints = [
      '/movies',
      '/series',
      '/movies/1',
      '/series/1'
    ];
    
    console.log('üß™ Testing all endpoints...');
    
    for (const endpoint of endpoints) {
      try {
        const response = await fetch(`https://moviehub-9b64.onrender.com/api${endpoint}`);
        console.log(`${endpoint}: ${response.status} ${response.ok ? '‚úÖ' : '‚ùå'}`);
      } catch (error) {
        console.log(`${endpoint}: ERROR - ${error.message} ‚ùå`);
      }
    }
  }
};

const refreshToken = async () => {
  try {
    const response = await api.post('/auth/refresh');
    localStorage.setItem('token', response.data.token);
    return response.data.token;
  } catch (error) {
    throw error;
  }
};

const handleFavoriteError = (error) => {
  if (error.response?.status === 401 || error.response?.status === 403) {
    //alert('Your session has expired. Please login again.');
    // State'i sƒ±fƒ±rla
    setIsFavorite(false);
  } else {
    //alert('Failed to update favorites. Please try again.');
  }
};

export default api;
